author: "dterletskiy"
version: "1.1.0"
umbs_min_version: "0.1"

variables:
  DIRECTORIES:
    # Current variable (DIRECTORIES.ROOT) could be changed during runtime initializetion in case if 'root_dir' parameter
    # defined in configuration file or command line parameter
    ROOT: "/mnt/docker/builder/"
    CONTAINER:
      ROOT: "/mnt/host/"
    SOURCE: ${DIRECTORIES.ROOT}/source/
    BUILD: ${DIRECTORIES.ROOT}/build/
    DEPLOY: ${DIRECTORIES.ROOT}/deploy/

  ANDROID:
    UBOOT_XT: &ANDROID_UBOOT_XENVM_TROUT_ALIAS
      SOURCE:
        URL: "https://github.com/xen-troops/android_u-boot_manifest.git"
        BRANCH: "xenvm-trout-main"
      CONFIG:
        ARM64: "//u-boot:xen-guest-android-virtio_aarch64_dist"
    
    UBOOT_MAINLINE: &ANDROID_UBOOT_MAINLINE_ALIAS
      SOURCE:
        URL: "https://android.googlesource.com/kernel/manifest"
        BRANCH: "u-boot-mainline"
      CONFIG:
        ARM64:
          QEMU: "//u-boot:qemu_aarch64_dist"
          XEN: "//u-boot:xen_aarch64_dist"
    
    UBOOT: *ANDROID_UBOOT_MAINLINE_ALIAS

components:
  android-u-boot-qemu:
    active: true
    subdir: android/u-boot
    sources:
      - type: repo
        manifest:
          url: ${ANDROID.UBOOT.SOURCE.URL}
          branch: ${ANDROID.UBOOT.SOURCE.BRANCH}
          name: "default.xml"
          depth: 1
        depth: 1
        subdir: "."
    builders:
      - type: bazel.common
        tool: "tools/bazel"
        starup_options:
          - "--max_idle_secs=1"
        command: run
        args:
          - "--verbose_failures"
          - "--sandbox_debug"
          - "--logging=6"
        config: ${ANDROID.UBOOT.CONFIG.ARM64.QEMU}
        target_patterns:
          - "--dist_dir=./_out_/qemu_aarch64/deploy"
        subdirs:
          target: "."
          product: "_out_/qemu_aarch64"
          deploy: "_out_/qemu_aarch64/deploy"
        env:
          - ""
        artifacts:
          - "_out_/qemu_aarch64/deploy/u-boot"
          - "_out_/qemu_aarch64/deploy/u-boot.bin"
        deps:
          - ""
  
  android-u-boot-xen:
    active: true
    subdir: android/u-boot
    sources:
      - type: repo
        manifest:
          url: ${ANDROID.UBOOT.SOURCE.URL}
          branch: ${ANDROID.UBOOT.SOURCE.BRANCH}
          name: "default.xml"
          depth: 1
        depth: 1
        subdir: "."
    builders:
      - type: bazel.common
        tool: "tools/bazel"
        starup_options:
          - "--max_idle_secs=1"
        command: run
        args:
          - "--verbose_failures"
          - "--sandbox_debug"
          - "--logging=6"
        config: ${ANDROID.UBOOT.CONFIG.ARM64.XEN}
        target_patterns:
          - "--dist_dir=./_out_/xen_aarch64/deploy"
        subdirs:
          target: "."
          product: "_out_/xen_aarch64"
          deploy: "_out_/xen_aarch64/deploy"
        env:
          - ""
        artifacts:
          - "_out_/xen_aarch64/deploy/u-boot"
          - "_out_/xen_aarch64/deploy/u-boot.bin"
        deps:
          - ""
